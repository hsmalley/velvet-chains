#!/usr/bin/env bash
set -euo pipefail

HOOK_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$HOOK_DIR/.." && pwd)"
BIN="$REPO_ROOT/rust_snark/target/release/git-snark"

if [[ ! -x "$BIN" ]]; then
  if command -v cargo >/dev/null 2>&1; then
    echo "[snark] building Rust hook binary..." >&2
    cargo build --manifest-path "$REPO_ROOT/rust_snark/Cargo.toml" --release >&2
  else
    echo "[snark] warning: cargo not found; skipping snark flourish" >&2
    exit 0
  fi
fi

if [[ ! -x "$BIN" ]]; then
  echo "[snark] git-snark binary still missing after build attempt" >&2
  exit 0
fi

ARGS=("--hook" "$1")
if [[ $# -ge 2 ]]; then
  ARGS+=("--source" "$2")
fi

"$BIN" "${ARGS[@]}"
