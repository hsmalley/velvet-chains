# üè¥‚Äç‚ò†Ô∏è Velvet Chains: Voidlight Lock Renewal Ritual
name: "üß¨ Voidlight Lock Renewal ‚Äî Concord Rite"

on:
  push:
    branches: [main]
    paths:
      - pyproject.toml
      - uv.lock
      - .github/workflows/voidlight-lock-ritual.yml
  pull_request:
    branches: [main]
    paths:
      - pyproject.toml
      - uv.lock
      - .github/workflows/voidlight-lock-ritual.yml
  schedule:
    - cron: "0 7 * * 1" # Mondays at 07:00 UTC (weekly concord rite)
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  upgrade-uv-lock:
    name: "üîÆ Reweave Dependency Sigils"
    runs-on: ubuntu-latest
    env:
      GH_PR_TOKEN: ${{ secrets.GH_PR_TOKEN }}
      UV_LOCK_MILESTONE: ${{ vars.UV_LOCK_MILESTONE }}
    steps:
      - name: ‚öì Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ github.ref }}

      - name: ‚ú® Setup uv
        uses: astral-sh/setup-uv@v7

      - name: üßµ Refresh lockfile
        run: uv lock --upgrade

      - name: üßÆ Compute checksum of lockfile
        run: sha256sum uv.lock > uv.lock.sha256

      - name: üìù Compose PR body with lock diff (first 20 lines)
        run: |
          {
            echo "This automated ritual refreshes \`uv.lock\` based on \`pyproject.toml\`."
            echo
            echo "- Command: \`uv lock --upgrade\`"
            echo "- Includes: \`uv.lock\` and \`uv.lock.sha256\`"
            echo "- Safety: CI verifies lock freshness via \`uv lock --check\`"
            echo
            echo "#### Diff Preview (first 20 lines)"
            echo "```diff"
            git diff --unified=3 -- uv.lock | sed -n '1,20p' || true
            echo "```"
          } > PR_BODY.md

      - name: ü§ù Open PR with renewed lock (with milestone)
        if: ${{ env.GH_PR_TOKEN != '' && env.UV_LOCK_MILESTONE != '' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ env.GH_PR_TOKEN }}
          commit-message: "üß¨ renew: update uv.lock to latest constraints"
          title: "üß¨ Renew uv.lock ‚Äî dependency refresh"
          body-path: PR_BODY.md

          branch: chore/renew-uv-lock
          add-paths: |
            uv.lock
            uv.lock.sha256
          signoff: true
          committer: "Obsidian Promise Bot <github-actions[bot]@users.noreply.github.com>"
          author: "Obsidian Promise Bot <github-actions[bot]@users.noreply.github.com>"
          labels: |
            dependencies
            uv-lock
          assignees: |
            hsmalley
          reviewers: |
            hsmalley
          milestone: ${{ env.UV_LOCK_MILESTONE }}
          delete-branch: true

      - name: ü§ù Open PR with renewed lock (no milestone)
        if: ${{ env.GH_PR_TOKEN != '' && env.UV_LOCK_MILESTONE == '' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ env.GH_PR_TOKEN }}
          commit-message: "üß¨ renew: update uv.lock to latest constraints"
          title: "üß¨ Renew uv.lock ‚Äî dependency refresh"
          body-path: PR_BODY.md

          branch: chore/renew-uv-lock
          add-paths: |
            uv.lock
            uv.lock.sha256
          signoff: true
          committer: "Obsidian Promise Bot <github-actions[bot]@users.noreply.github.com>"
          author: "Obsidian Promise Bot <github-actions[bot]@users.noreply.github.com>"
          labels: |
            dependencies
            uv-lock
          assignees: |
            hsmalley
          reviewers: |
            hsmalley
          delete-branch: true

      - name: üìù PR permission missing ‚Äî leave a captain‚Äôs note
        if: ${{ env.GH_PR_TOKEN == '' }}
        run: |
          echo "### üîí Cannot open PR from Actions" >> $GITHUB_STEP_SUMMARY
          echo "This repository disallows Actions-created PRs or lacks a PAT." >> $GITHUB_STEP_SUMMARY
          echo "Add a classic Personal Access Token (repo scope) named \`GH_PR_TOKEN\` to repository secrets, or enable the repository setting: \"Allow GitHub Actions to create and approve pull requests\"." >> $GITHUB_STEP_SUMMARY
