# 🏴‍☠️ Velvet Chains Armada Release
# Tags → Build static site → Cut GitHub Release with artifacts
name: "✨ Armada Release: Velvet Chains"

on:
  push:
    tags:
      - "v*" # Release on version tags like v1.2.3
  workflow_dispatch:
    inputs:
      tag:
        description: "Optional tag to release (e.g. v1.2.3)"
        required: false

permissions:
  contents: write
  actions: read

concurrency:
  group: release-${{ github.ref_name || inputs.tag }}
  cancel-in-progress: false

jobs:
  build-site:
    name: 🎭 Forge Static Site Artifact
    runs-on: ubuntu-latest
    steps:
      - name: ⚓ Hoist the Colors — Checkout
        uses: actions/checkout@v5
      - name: 🔮 Scry for Next.js Portal (app/pages)
        id: site
        run: |
          if [ -d app ] || [ -d pages ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
            echo "No Next.js portal (app/ or pages/) detected; skipping site build." >&2
          fi

      - name: 🏴‍☠️ Prepare the Ship — Setup Node.js
        if: ${{ steps.site.outputs.present == 'true' }}
        uses: actions/setup-node@v5
        with:
          node-version: "20"
          cache: npm

      - name: 💎 Gather the Treasure — Install Dependencies
        if: ${{ steps.site.outputs.present == 'true' }}
        run: npm ci

      - name: 🧪 Validate Lore Codex (conditional)
        if:
          ${{ steps.site.outputs.present == 'true' && hashFiles('scripts/validate_lore.py') != '' }}
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pyyaml
          npm run validate:lore

      - name: 📚 Build Lore JSON (conditional)
        if:
          ${{ steps.site.outputs.present == 'true' && hashFiles('scripts/build_lore_json.py') != ''
          }}
        run: npm run build:lore

      - name: ⚔️ Forge the Spectacle — Build
        if: ${{ steps.site.outputs.present == 'true' }}
        run: npm run build

      - name: 📦 Package Site Artifact
        if: ${{ steps.site.outputs.present == 'true' }}
        run: |
          VERSION="${GITHUB_REF_NAME:-manual}"
          ARCHIVE="velvet-chains-site-${VERSION}.tgz"
          tar -czf "$ARCHIVE" out
          echo "$ARCHIVE" > archive_name.txt
          sha256sum "$ARCHIVE" > "$ARCHIVE.sha256"

      - name: 📜 Upload Artifact for Release
        if: ${{ steps.site.outputs.present == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: site-package
          path: |
            *.tgz
            *.tgz.sha256
            archive_name.txt

  rust-binaries:
    name: ⚔️ Forge Rust Binaries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
          - target: x86_64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip
    steps:
      - name: 📦 Hoist the Colors — Checkout
        uses: actions/checkout@v5
      - name: 🔎 Detect Rust Engine
        id: rust
        shell: bash
        run: |
          if [ -f voidlight_engine/Cargo.toml ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
            echo "No Rust engine found; skipping binaries for ${{ matrix.target }}" >&2
          fi
      - name: 🛠️ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
        if: ${{ steps.rust.outputs.present == 'true' }}
      - name: 🔥 Build release binary
        if: ${{ steps.rust.outputs.present == 'true' }}
        run:
          cargo build --release --manifest-path voidlight_engine/Cargo.toml --target ${{
          matrix.target }}
      - name: 📦 Package binary (unix)
        if: ${{ steps.rust.outputs.present == 'true' && matrix.archive == 'tar.gz' }}
        run: |
          NAME="git-voidlight-${{ matrix.target }}"
          cp "voidlight_engine/target/${{ matrix.target }}/release/git-voidlight" "${NAME}"
          tar -czf "${NAME}.tar.gz" "${NAME}"
          sha256sum "${NAME}.tar.gz" > "${NAME}.tar.gz.sha256"
      - name: 📦 Package binary (windows)
        if: ${{ steps.rust.outputs.present == 'true' && matrix.archive == 'zip' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $name = "git-voidlight-${{ matrix.target }}.exe"
          Copy-Item "voidlight_engine/target/${{ matrix.target }}/release/git-voidlight.exe" $name -Force
          $zip = $name -replace '\.exe$',''
          Compress-Archive -Path $name -DestinationPath "$zip.zip" -Force
          (Get-FileHash "$zip.zip" -Algorithm SHA256).Hash | Out-File -FilePath "$zip.zip.sha256" -Encoding ascii
      - name: 🚀 Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-${{ matrix.target }}
          path: |
            git-voidlight-${{ matrix.target }}.tar.gz
            git-voidlight-${{ matrix.target }}.tar.gz.sha256
            git-voidlight-${{ matrix.target }}.zip
            git-voidlight-${{ matrix.target }}.zip.sha256
        if: ${{ steps.rust.outputs.present == 'true' }}

  python-package:
    name: 🐍 Build Python Package
    runs-on: ubuntu-latest
    steps:
      - name: 📦 Hoist the Colors — Checkout
        uses: actions/checkout@v5
      - name: 🔎 Detect Python package metadata
        id: py
        run: |
          if [ -f pyproject.toml ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
            echo "No pyproject.toml found; skipping Python package build." >&2
          fi
      - name: 🔥 Setup Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - name: ✨ Setup uv
        uses: astral-sh/setup-uv@v7
      - name: 🌱 Create uv virtual environment
        if: ${{ steps.py.outputs.present == 'true' }}
        run: uv venv
      - name: 🔒 Verify uv.lock is up to date
        if: ${{ steps.py.outputs.present == 'true' && hashFiles('uv.lock') != '' }}
        run: uv lock --check
      - name: 🧰 Install build tooling
        if: ${{ steps.py.outputs.present == 'true' }}
        run: uv pip install build twine
      - name: 🎭 Build dist
        if: ${{ steps.py.outputs.present == 'true' }}
        run: uv run python -m build
      - name: 🚀 Upload python dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/*
        if: ${{ steps.py.outputs.present == 'true' }}

  github-release:
    name: 🌌 Unfurl Cosmic Release Scroll
    needs: [build-site, rust-binaries, python-package]
    # Ensure we only attempt a GitHub Release when a tag exists or is provided via workflow_dispatch
    if:
      startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' &&
      inputs.tag != '')
    runs-on: ubuntu-latest
    steps:
      - name: 🔖 Resolve Tag Name
        id: tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            echo "name=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "name=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi
      - name: 📥 Summon all Relics from the Vault
        uses: actions/download-artifact@v6
        with:
          pattern: "*"
          path: releases
          merge-multiple: true

      - name: 🗂️ Resolve Archive Name
        id: meta
        run: |
          if [ -f releases/archive_name.txt ]; then
            NAME=$(cat releases/archive_name.txt)
            echo "archive=$NAME" >> "$GITHUB_OUTPUT"
          else
            echo "archive=" >> "$GITHUB_OUTPUT"
          fi

      - name: 🔮 Scry Missing Checksums (Python dists)
        run: |
          shopt -s nullglob
          for f in releases/*.whl releases/*tar.gz; do
            [ -e "$f" ] || continue
            if [ ! -f "$f.sha256" ]; then
              sha256sum "$f" > "$f.sha256"
            fi
          done

      - name: 🧾 Inscribe the Assets Ledger
        run: |
          {
            echo "## Assets"
            echo
            echo "Filename | Size | SHA-256"
            echo "--- | ---: | ---"
            shopt -s nullglob
            for f in releases/*; do
              case "$f" in
                *.sha256|*/archive_name.txt) continue;;
              esac
              SIZE_BYTES=$(stat -c%s "$f")
              SIZE_MB=$(awk -v s="$SIZE_BYTES" 'BEGIN{printf "%.2f MB", s/1024/1024}')
              if [ -f "$f.sha256" ]; then
                SUM=$(cut -d' ' -f1 < "$f.sha256")
              else
                SUM="(no checksum)"
              fi
              echo "$(basename "$f") | $SIZE_MB | \`$SUM\`"
            done | sort
            echo
          } > releases/RELEASE_BODY.md

      - name: 🧰 Muster the Cargo Manifest
        run: |
          set -euo pipefail
          : > filelist.txt
          ARCHIVE="${{ steps.meta.outputs.archive }}"
          if [ -n "$ARCHIVE" ] && [ -f "releases/$ARCHIVE" ]; then
            echo "releases/$ARCHIVE" >> filelist.txt
            [ -f "releases/$ARCHIVE.sha256" ] && echo "releases/$ARCHIVE.sha256" >> filelist.txt
          fi
          for f in releases/git-voidlight-*.tar.gz releases/git-voidlight-*.tar.gz.sha256 releases/git-voidlight-*.zip releases/git-voidlight-*.zip.sha256 releases/*.whl releases/*-*.tar.gz; do
            [ -e "$f" ] && echo "$f" >> filelist.txt || true
          done

      - name: 🌌 Publish Release to the Void
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.name }}
          target_commitish: ${{ github.sha }}
          files: filelist.txt
          body_path: releases/RELEASE_BODY.md
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
